<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工人事管理系统 - 登录</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="/css/style-login.css">
</head>
<body>
<div class="login-container">
    <div class="login-header">
        <h2>员工人事管理系统</h2>
        <p>请登录您的账户</p>
    </div>

    <form id="login-form">
        <div class="mb-3 form-group-icon">
            <label for="username" class="form-label">用户名</label>
            <input type="text" class="form-control" id="username" placeholder="请输入用户名" required>
            <!--<i class="fas fa-user"></i>-->
            <div class="error-message">请输入用户名</div>
        </div>

        <div class="mb-3 form-group-icon">
            <label for="password" class="form-label">密码</label>
            <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
            <!--<i class="fas fa-lock"></i>-->
            <div class="error-message">请输入密码</div>
        </div>

        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="autoLogin">
            <label class="form-check-label" for="autoLogin">记住我</label>
        </div>

        <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-sign-in-alt"></i>
            登录
        </button>
    </form>

    <div class="login-footer">
        <p>没有账户？ <a href="register.html">立即注册</a></p>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // 获取表单数据
            const formData = {
                username: document.getElementById("username").value,
                password: await hashPassword(document.getElementById("password").value),
                autoLogin: document.getElementById("autoLogin").checked ? "ON" : "OFF"
            };

            // 前端验证
            if (!validateForm(formData)) {
                return;
            }

            try {
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.textContent = '登录中...';
                submitBtn.disabled = true;

                // 获取用户IP及地理位置信息
                let ipInfo = {
                    ip: '',
                    province: '',
                    areaLat: '',
                    areaLng: ''
                };
                /*
                try {
                    const IPAddressResponse = await fetch('https://ipservice.ws.126.net/locate/api/getLocByIp', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const ipResult = await IPAddressResponse.json();

                    // 根据实际返回数据结构提取需要的信息
                    if (ipResult.status === 200 && ipResult.result) {
                        ipInfo = {
                            ip: ipResult.result.ip || '',
                            province: ipResult.result.province || '',
                            areaLat: ipResult.result.areaLat || '',
                            areaLng: ipResult.result.areaLng || ''
                        };
                    }
                } catch (ipError) {
                    console.error('获取IP地址信息失败:', ipError);
                }

                 */

                // 构建完整的表单数据，包含IP信息
                const completeFormData = {
                    ...formData,
                    ip: ipInfo.ip,
                    province: ipInfo.province,
                    areaLat: ipInfo.areaLat,
                    areaLng: ipInfo.areaLng,
                    userAgent: navigator.userAgent
                };

                // 发送登录请求到后端
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(completeFormData)
                });

                // 处理登录响应
                const result = await response.json();

                if (response.ok) {
                    // 登录成功
                    localStorage.setItem("username",completeFormData.username);
                    window.location.href = '/index?id=' + result.data + '&username=' + encodeURIComponent(completeFormData.username);
                } else {
                    // 登录失败
                    alert(`登录失败: ${result.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('登录过程中发生错误:', error);
                console.error(error.toString());
                alert('网络错误，请稍后重试');
            } finally {
                // 恢复按钮状态
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = '登录';
                    submitBtn.disabled = false;
                }
            }
        });

        // 表单验证函数
        function validateForm(data) {
            // 检查必填字段
            if (!data.username || !data.password) {
                alert('请填写用户名和密码！');
                return false;
            }

            // 检查用户名长度
            if (data.username.length < 2 || data.username.length > 20) {
                alert('用户名长度应在2-20个字符之间');
                return false;
            }

            // 检查密码长度
            if (data.password.length < 6) {
                alert('密码长度至少6位');
                return false;
            }

            return true;
        }

        async function hashPassword(password) {
            // 将字符串编码为Uint8Array
            const encoder = new TextEncoder();
            const data = encoder.encode(password);

            // 使用SHA-256进行哈希
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);

            // 将ArrayBuffer转换为十六进制字符串
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            return hashHex;
        }
    </script>
</body>
</html>